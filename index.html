<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="robots" content="index,follow" />
<meta name="description" content="..." />
    <title>Image Compressor</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background:#f4f4f4;
    padding:20px;
}
.box {
    background:#fff;
    padding:20px;
    max-width:1200px;
    margin:auto;
    border-radius:8px;
}
.dropzone {
    border:2px dashed #aaa;
    padding:25px;
    text-align:center;
    cursor:pointer;
}
.dropzone.dragover { background:#eef; }

.tabs {
    display:flex;
    margin-top:20px;
    border-bottom:2px solid #ddd;
}
.tab {
    padding:12px 20px;
    cursor:pointer;
    border-bottom:3px solid transparent;
}
.tab.active {
    border-color:#2196F3;
    font-weight:bold;
}

.tabContent {
    display:none;
    margin-top:20px;
}
.tabContent.active { display:block; }

input[type=range] { width:100%; }

.previewItem {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:15px;
    margin-top:20px;
    padding:15px;
    border:1px solid #ddd;
    background:#fafafa;
    border-radius:6px;
}
.previewItem img {
    width:100%;
    max-height:280px;
    object-fit:contain;
    background:#fff;
    border:1px solid #ccc;
}
.info {
    grid-column:span 2;
    font-size:14px;
}
.download {
    grid-column:span 2;
    background:#4CAF50;
    color:white;
    text-align:center;
    padding:10px;
    border-radius:5px;
    text-decoration:none;
}
#zipBtn {
    margin-top:20px;
    width:100%;
    padding:10px;
}
</style>
</head>

<body>
<div class="box">
<h2>Offline Medien-Kompressor</h2>

<div class="dropzone" id="dropzone">
    Dateien hier ablegen oder klicken
    <input type="file" id="fileInput"
           accept="image/jpeg,image/png,image/webp,application/pdf"
           multiple hidden>
</div>

<div class="tabs">
    <div class="tab active" data-tab="jpg">JPG</div>
    <div class="tab" data-tab="webp">WebP</div>
    <div class="tab" data-tab="png">PNG</div>
    <div class="tab" data-tab="pdf">PDF</div>
</div>

<div class="tabContent active" id="jpg">
    <label>JPEG Qualität: <span id="jpgVal">70</span>%</label>
    <input type="range" id="jpgQ" min="10" max="100" step="1" value="70">
</div>

<div class="tabContent" id="webp">
    <label>WebP Qualität: <span id="webpVal">70</span>%</label>
    <input type="range" id="webpQ" min="10" max="100" step="1" value="70">
</div>

<div class="tabContent" id="png">
    <label>PNG Farben: <span id="pngVal">256</span></label>
    <input type="range" id="pngC" min="1" max="256" value="256">
</div>

<div class="tabContent" id="pdf">
    <label>PDF Bildqualität: <span id="pdfVal">70</span>%</label>
    <input type="range" id="pdfQ" min="10" max="100" step="1" value="70">
</div>

<button id="zipBtn">Alle Ergebnisse als ZIP herunterladen</button>
<div id="preview"></div>
</div>

<script>
const dropzone = document.getElementById("dropzone");
const fileInput = document.getElementById("fileInput");
const preview = document.getElementById("preview");
const zipBtn = document.getElementById("zipBtn");

const jpgQ = document.getElementById("jpgQ");
const webpQ = document.getElementById("webpQ");
const pngC = document.getElementById("pngC");
const pdfQ = document.getElementById("pdfQ");

const jpgVal = document.getElementById("jpgVal");
const webpVal = document.getElementById("webpVal");
const pngVal = document.getElementById("pngVal");
const pdfVal = document.getElementById("pdfVal");

let files = [];
let zipFiles = [];

/* Tabs */
document.querySelectorAll(".tab").forEach(tab=>{
    tab.onclick=()=>{
        document.querySelectorAll(".tab,.tabContent").forEach(e=>e.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
        render();
    };
});

/* Slider */
[jpgQ,webpQ,pngC,pdfQ].forEach(i=>{
    i.oninput=()=>{
        jpgVal.textContent=jpgQ.value;
        webpVal.textContent=webpQ.value;
        pngVal.textContent=pngC.value;
        pdfVal.textContent=pdfQ.value;
        render();
    };
});

/* Drag & Drop */
dropzone.onclick=()=>fileInput.click();
dropzone.ondragover=e=>{e.preventDefault();dropzone.classList.add("dragover");};
dropzone.ondragleave=()=>dropzone.classList.remove("dragover");
dropzone.ondrop=e=>{
    e.preventDefault();
    dropzone.classList.remove("dragover");
    files=[...e.dataTransfer.files];
    render();
};
fileInput.onchange=e=>{
    files=[...e.target.files];
    render();
};

/* PNG Quantisierung */
function quantize(ctx,w,h,colors){
    const img=ctx.getImageData(0,0,w,h);
    const d=img.data;
    const step=Math.max(1,Math.floor(256/Math.cbrt(colors)));
    for(let i=0;i<d.length;i+=4){
        d[i]=Math.floor(d[i]/step)*step;
        d[i+1]=Math.floor(d[i+1]/step)*step;
        d[i+2]=Math.floor(d[i+2]/step)*step;
    }
    ctx.putImageData(img,0,0);
}

/* Render */
async function render(){
    preview.innerHTML="";
    zipFiles=[];
    const active=document.querySelector(".tab.active").dataset.tab;

    for(const file of files){
        if(active==="pdf" && file.type==="application/pdf"){
            const bytes=await file.arrayBuffer();
            const pdf=await PDFLib.PDFDocument.load(bytes);
            const out=await pdf.save();
            zipFiles.push({name:file.name,blob:new Blob([out])});
            preview.innerHTML+=`
                <div class="previewItem">
                    <div>PDF Original: ${(file.size/1024).toFixed(1)} KB</div>
                    <div>PDF Neu: ${(out.byteLength/1024).toFixed(1)} KB</div>
                    <div class="info">PDF wurde neu gespeichert (Bildkompression folgt als nächster Schritt)</div>
                </div>`;
        }

        if(file.type.startsWith("image/")){
            const img=new Image();
            img.src=URL.createObjectURL(file);
            await img.decode();

            const c=document.createElement("canvas");
            c.width=img.width;
            c.height=img.height;
            const ctx=c.getContext("2d");
            ctx.drawImage(img,0,0);

            let type="image/jpeg",q=0.7;
            if(active==="jpg"){type="image/jpeg";q=jpgQ.value/100;}
            if(active==="webp"){type="image/webp";q=webpQ.value/100;}
            if(active==="png"){quantize(ctx,c.width,c.height,pngC.value);type="image/png";}

            const blob=await new Promise(r=>c.toBlob(r,type,q));
            zipFiles.push({name:file.name,blob});

            const saved=100-(blob.size/file.size*100);
            preview.innerHTML+=`
                <div class="previewItem">
                    <img src="${URL.createObjectURL(file)}">
                    <img src="${URL.createObjectURL(blob)}">
                    <div class="info">
                        Original ${(file.size/1024).toFixed(1)} KB →
                        Neu ${(blob.size/1024).toFixed(1)} KB
                        (${saved.toFixed(1)}%)
                    </div>
                    <a class="download" download="${file.name}" href="${URL.createObjectURL(blob)}">
                        Einzeln herunterladen
                    </a>
                </div>`;
        }
    }
}

/* ZIP */
zipBtn.onclick=async()=>{
    const zip=new JSZip();
    zipFiles.forEach(f=>zip.file(f.name,f.blob));
    const blob=await zip.generateAsync({type:"blob"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="komprimiert.zip";
    a.click();
};
</script>
</body>
</html>
